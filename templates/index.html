
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini to OpenAI Proxy</title>
    <link rel="icon" href="/favicon.ico" type="image/svg+xml">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        /* Small adjustment for the fixed Bootstrap navbar */
        body { padding-top: 5rem; }
        /* Custom styles for code blocks to fit Bootstrap's aesthetic */
        code { background-color: #e9ecef; padding: 2px 6px; border-radius: 4px; font-family: "SF Mono", "Fira Code", "Source Code Pro", monospace; }
        pre { background-color: #e9ecef; padding: 1em; border-radius: 4px; overflow-x: auto; }
        /* Ensure content sections are hidden by default, as before */
        .content-section { display: none; }
    </style>
</head>
<body>
<!-- Bootstrap Navbar -->
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <div class="container">
        <a class="navbar-brand" href="#">üöÄ Gemini to OpenAI Proxy</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="#home">üè† Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#configuration">‚öôÔ∏è Configuration</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#prompts">‚úçÔ∏è Prompts</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#mcp">üõ†Ô∏è MCP</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Main Content Container -->
<div class="container">
    <h1 class="my-4">üöÄ Gemini to OpenAI Proxy</h1>

    <!-- Home Section -->
    <div id="home" class="content-section">
        <p class="lead">This is a lightweight proxy server that translates requests from an OpenAI-compatible client (like JetBrains AI Assistant) to Google's Gemini API.</p>

        <h2 class="mt-4">‚ú® What It Does</h2>
        <ul>
            <li>Accepts requests on OpenAI-like endpoints: <code>/v1/chat/completions</code> and <code>/v1/models</code>.</li>
            <li>Transforms the request format from OpenAI's structure to Gemini's structure.</li>
            <li>Handles streaming responses for chat completions.</li>
            <li>Manages basic conversation history truncation to fit within the model's token limits.</li>
            <li>Caches model lists to reduce upstream API calls.</li>
            <li>Supports multimodal requests (text and images).</li>
            <li>Supports MCP tools for function calling.</li>
        </ul>

        <h2 class="mt-4">üöÄ How to Use</h2>

        <h3>1. Setup and Run</h3>
        <p>Before running the server, you need to set one environment variable (or use the form above for the API Key):</p>
        <pre><code class="language-bash">
 export API_KEY="YOUR_GEMINI_API_KEY"
 export UPSTREAM_URL="https://generativelanguage.googleapis.com"
        </code></pre>
        <p>Then, run the server:</p>
        <pre><code class="language-bash">
 python3.12 -m venv
 source venv/bin/activate
 pip install -r requirements.txt
 python3.12 gemini-proxy.py
        </code></pre>
        <p>or Docker Version</p>
        <pre><code class="language-bash">docker-composer up -d</code></pre>
        <p>The server will start on <code>http://0.0.0.0:8080</code> by default.</p>


        <h3 class="mt-4">2. Configure JetBrains AI Assistant</h3>
        <p>To use this proxy with JetBrains IDEs:</p>
        <ol>
            <li>Open AI Assistant settings (<code>Settings</code> > <code>Tools</code> > <code>AI Assistant</code> > <code>Models</code>).</li>
            <li>Select the "OpenAI API" service.</li>
            <li>Set the <b>Server URL</b> to: <code>http://&lt;your-server-ip-or-localhost&gt;:8080/v1/</code></li>
            <li>The model list will be fetched automatically. You can leave it as default or choose a specific one.</li>
        </ol>
        <p class="alert alert-info"><b>Note:</b> The path must end with <code>/v1/</code> because the IDE will append <code>/chat/completions</code> or <code>/models</code> to it.</p>

        <h2 class="mt-4">üì° Available Endpoints</h2>
        <ul>
            <li><code>GET /</code>: This documentation and setup page.</li>
            <li><code>GET /v1/models</code>: Lists available Gemini models in OpenAI format.</li>
            <li><code>POST /v1/chat/completions</code>: The main endpoint for chat completions. Supports streaming.</li>
        </ul>
    </div>

    <!-- Configuration Section -->
    <div id="configuration" class="content-section">
        <h2 class="mt-4">üîë API Key Setup</h2>
        <p>You can set your Gemini API Key using the form below. The key is stored in memory and will be reset when the server restarts. You can also set it permanently using the <code>API_KEY</code> environment variable.</p>
        <form action="/set_api_key" method="POST">
            <div class="mb-3">
                <label for="api_key" class="form-label"><b>üîë Gemini API Key:</b></label>
                <input type="text" class="form-control" id="api_key" name="api_key" placeholder="Enter your Gemini API key" value="{{ API_KEY or '' }}">
            </div>
            <button type="submit" class="btn btn-primary">üíæ Save Key</button>
        </form>
        <p class="mt-3"><b>Current Status:</b> The API Key is currently <strong class="text-{{ 'success' if API_KEY else 'danger' }}">{{ api_key_status }}</strong>.</p>

        <hr class="my-4">
        <h3 class="mt-4">üêû Debugging</h3>
        <form action="/set_logging" method="POST">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="verbose_logging" name="verbose_logging"
                       {% if verbose_logging_status %}checked{% endif %} onchange="this.form.submit()">
                <label class="form-check-label" for="verbose_logging">Enable Verbose Console Logging</label>
            </div>
            <div class="form-text">Toggles detailed logging of requests, responses, and other events in the server console.</div>
        </form>
    </div>

    <!-- MCP Tools Section -->
    <div id="mcp" class="content-section">
        <h2 class="mt-4">üõ†Ô∏è MCP Tools Configuration</h2>
        <p>Configure MCP tools by providing a JSON configuration. This will be saved to <code>mcp_config.json</code>.</p>

        <form action="/set_mcp_config" method="POST" id="mcp-form">
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" role="switch" id="mcp-editor-mode-switch" checked>
                <label class="form-check-label" for="mcp-editor-mode-switch">Use User-Friendly Editor (vs. Advanced JSON)</label>
            </div>

            <!-- User-Friendly Editor -->
            <div id="mcp-user-friendly-editor">
                <div id="mcp-servers-container" class="accordion mb-3">
                    {% if mcp_config.mcpServers %}
                    {% for server_name, server_details in mcp_config.mcpServers.items() %}
                    <div class="accordion-item" data-server-name="{{ server_name }}">
                        <h2 class="accordion-header" id="mcp-heading-{{ loop.index }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mcp-collapse-{{ loop.index }}" aria-expanded="false" aria-controls="mcp-collapse-{{ loop.index }}">
                                {{ server_name }}
                            </button>
                        </h2>
                        <div id="mcp-collapse-{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="mcp-heading-{{ loop.index }}" data-bs-parent="#mcp-servers-container">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <label class="form-label"><b>Server Name</b></label>
                                    <input type="text" class="form-control mcp-server-name-input" value="{{ server_name }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label"><b>Command</b></label>
                                    <input type="text" class="form-control mcp-command-input" value="{{ server_details.command or '' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label"><b>Arguments</b></label>
                                    <div class="mcp-args-container">
                                        {% if server_details.args %}
                                        {% for arg in server_details.args %}
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control mcp-arg-input" value="{{ arg }}">
                                            <button class="btn btn-outline-danger mcp-remove-item-btn" type="button">‚úñ</button>
                                        </div>
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary mcp-add-arg-btn" type="button">Add Argument</button>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label"><b>Environment Variables</b></label>
                                    <div class="mcp-env-container">
                                        {% if server_details.env %}
                                        {% for key, value in server_details.env.items() %}
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control mcp-env-key-input" placeholder="Key" value="{{ key }}">
                                            <span class="input-group-text">=</span>
                                            <input type="text" class="form-control mcp-env-value-input" placeholder="Value" value="{{ value }}">
                                            <button class="btn btn-outline-danger mcp-remove-item-btn" type="button">‚úñ</button>
                                        </div>
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary mcp-add-env-btn" type="button">Add Variable</button>
                                </div>
                                <button class="btn btn-danger mcp-delete-server-btn" type="button">Delete Server</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
                <button type="button" class="btn btn-success mb-3" id="mcp-add-server-btn">‚ûï Add New Server</button>
            </div>

            <!-- Advanced Editor -->
            <div id="mcp-advanced-editor" class="d-none">
                <textarea class="form-control" name="mcp_config" id="mcp_config_textarea" rows="15">{{ current_mcp_config_str or default_mcp_config_json }}</textarea>
            </div>

            <hr>
            <button type="submit" class="btn btn-primary btn-lg">üíæ Save MCP Config</button>
        </form>
        <script>
        document.addEventListener('DOMContentLoaded', function () {
            // MCP Editor Logic
            const mcpUserFriendlyEditor = document.getElementById('mcp-user-friendly-editor');
            const mcpAdvancedEditor = document.getElementById('mcp-advanced-editor');
            const mcpEditorSwitch = document.getElementById('mcp-editor-mode-switch');
            const mcpTextarea = document.getElementById('mcp_config_textarea');
            const mcpContainer = document.getElementById('mcp-servers-container');

            function toggleMcpEditorView() {
                if (!mcpEditorSwitch) return;
                if (mcpEditorSwitch.checked) {
                    mcpUserFriendlyEditor.classList.remove('d-none');
                    mcpAdvancedEditor.classList.add('d-none');
                } else {
                    mcpUserFriendlyEditor.classList.add('d-none');
                    mcpAdvancedEditor.classList.remove('d-none');
                }
            }

            if (mcpEditorSwitch) {
                mcpEditorSwitch.addEventListener('change', toggleMcpEditorView);
                toggleMcpEditorView(); // Initial state
            }

            if (!mcpContainer) return;
            let mcpServerCounter = mcpContainer.children.length;

            const mcpArgTemplate = `
                <div class="input-group mb-2">
                    <input type="text" class="form-control mcp-arg-input" value="">
                    <button class="btn btn-outline-danger mcp-remove-item-btn" type="button">‚úñ</button>
                </div>`;

            const mcpEnvTemplate = `
                <div class="input-group mb-2">
                    <input type="text" class="form-control mcp-env-key-input" placeholder="Key" value="">
                    <span class="input-group-text">=</span>
                    <input type="text" class="form-control mcp-env-value-input" placeholder="Value" value="">
                    <button class="btn btn-outline-danger mcp-remove-item-btn" type="button">‚úñ</button>
                </div>`;

            mcpContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('mcp-add-arg-btn')) {
                    e.target.previousElementSibling.insertAdjacentHTML('beforeend', mcpArgTemplate);
                }
                if (e.target.classList.contains('mcp-add-env-btn')) {
                    e.target.previousElementSibling.insertAdjacentHTML('beforeend', mcpEnvTemplate);
                }
                if (e.target.classList.contains('mcp-remove-item-btn')) {
                    e.target.closest('.input-group').remove();
                }
                if (e.target.classList.contains('mcp-delete-server-btn')) {
                    e.target.closest('.accordion-item').remove();
                }
            });

            mcpContainer.addEventListener('input', function(e) {
                if (e.target.classList.contains('mcp-server-name-input')) {
                    const newName = e.target.value || 'New Server';
                    const headerButton = e.target.closest('.accordion-item').querySelector('.accordion-button');
                    headerButton.textContent = newName;
                }
            });

            const addServerBtn = document.getElementById('mcp-add-server-btn');
            if (addServerBtn) {
                addServerBtn.addEventListener('click', function() {
                    mcpServerCounter++;
                    const newServerTemplate = `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="mcp-heading-${mcpServerCounter}">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#mcp-collapse-${mcpServerCounter}" aria-expanded="true" aria-controls="mcp-collapse-${mcpServerCounter}">
                                    New Server
                                </button>
                            </h2>
                            <div id="mcp-collapse-${mcpServerCounter}" class="accordion-collapse collapse show" aria-labelledby="mcp-heading-${mcpServerCounter}" data-bs-parent="#mcp-servers-container">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <label class="form-label"><b>Server Name</b></label>
                                        <input type="text" class="form-control mcp-server-name-input" value="new_server_${mcpServerCounter}">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label"><b>Command</b></label>
                                        <input type="text" class="form-control mcp-command-input" value="">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label"><b>Arguments</b></label>
                                        <div class="mcp-args-container"></div>
                                        <button class="btn btn-sm btn-outline-secondary mcp-add-arg-btn" type="button">Add Argument</button>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label"><b>Environment Variables</b></label>
                                        <div class="mcp-env-container"></div>
                                        <button class="btn btn-sm btn-outline-secondary mcp-add-env-btn" type="button">Add Variable</button>
                                    </div>
                                    <button class="btn btn-danger mcp-delete-server-btn" type="button">Delete Server</button>
                                </div>
                            </div>
                        </div>`;
                    mcpContainer.insertAdjacentHTML('beforeend', newServerTemplate);
                });
            }

            const mcpForm = document.getElementById('mcp-form');
            if (mcpForm) {
                mcpForm.addEventListener('submit', function() {
                    if (mcpEditorSwitch.checked) {
                        const mcpData = { mcpServers: {} };
                        mcpContainer.querySelectorAll('.accordion-item').forEach(item => {
                            const serverNameInput = item.querySelector('.mcp-server-name-input');
                            const serverName = serverNameInput ? serverNameInput.value.trim() : '';

                            if (serverName) {
                                const command = item.querySelector('.mcp-command-input').value.trim();
                                const args = Array.from(item.querySelectorAll('.mcp-arg-input'))
                                    .map(input => input.value.trim())
                                    .filter(Boolean);

                                const env = {};
                                item.querySelectorAll('.mcp-env-container .input-group').forEach(group => {
                                    const keyInput = group.querySelector('.mcp-env-key-input');
                                    const valueInput = group.querySelector('.mcp-env-value-input');
                                    if (keyInput && valueInput) {
                                        const key = keyInput.value.trim();
                                        if (key) {
                                            env[key] = valueInput.value;
                                        }
                                    }
                                });

                                mcpData.mcpServers[serverName] = { command, args, env };
                            }
                        });
                        mcpTextarea.value = JSON.stringify(mcpData, null, 2);
                    }
                });
            }
        });
        </script>
    </div>

    <!-- Prompt Engineering Section -->
    <div id="prompts" class="content-section">
        <h2 class="mt-4">‚úçÔ∏è Prompt Engineering</h2>
        <p>Define profiles to override parts of a prompt. Each profile has a name, triggers to activate it, and overrides for replacements. The proxy applies the first matching profile based on trigger phrases in the conversation.</p>

        <form action="/set_prompt_config" method="POST" id="prompt-form">

            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" role="switch" id="prompt-editor-mode-switch" checked>
                <label class="form-check-label" for="prompt-editor-mode-switch">Use User-Friendly Editor (vs. Advanced JSON)</label>
            </div>

            <!-- User-Friendly Editor -->
            <div id="user-friendly-editor">
                <div id="prompt-profiles-container" class="accordion mb-3">
                    {% for profile_name, profile in prompt_profiles.items() %}
                    <div class="accordion-item" data-profile-name="{{ profile_name }}">
                        <h2 class="accordion-header" id="heading-{{ loop.index }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false" aria-controls="collapse-{{ loop.index }}">
                                {{ profile_name }}
                            </button>
                        </h2>
                        <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ loop.index }}" data-bs-parent="#prompt-profiles-container">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <label class="form-label"><b>Profile Name</b></label>
                                    <input type="text" class="form-control profile-name-input" value="{{ profile_name }}">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><b>Triggers</b> (phrases that activate this profile)</label>
                                    <div class="triggers-container">
                                        {% for trigger in profile.triggers %}
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control trigger-input" value="{{ trigger }}">
                                            <button class="btn btn-outline-danger remove-item-btn" type="button">‚úñ</button>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary add-trigger-btn" type="button">Add Trigger</button>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><b>Overrides</b> (text to find and replace)</label>
                                    <div class="overrides-container">
                                        {% for key, value in profile.overrides.items() %}
                                        <div class="input-group mb-2">
                                            <span class="input-group-text" style="width: 50px;">Find</span>
                                            <input type="text" class="form-control override-key-input" placeholder="Text to find" value="{{ key }}">
                                            <span class="input-group-text" style="width: 80px;">Replace</span>
                                            <input type="text" class="form-control override-value-input" placeholder="Replacement text" value="{{ value }}">
                                            <button class="btn btn-outline-danger remove-item-btn" type="button">‚úñ</button>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary add-override-btn" type="button">Add Override</button>
                                </div>
                                <button class="btn btn-danger delete-profile-btn" type="button">Delete Profile</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-success mb-3" id="add-profile-btn">‚ûï Add New Profile</button>
            </div>

            <!-- Advanced Editor -->
            <div id="advanced-editor" class="d-none">
                <textarea class="form-control" name="prompt_overrides" id="prompt_overrides_textarea" rows="20">{{ current_prompt_overrides_str or default_prompt_overrides_json }}</textarea>
            </div>

            <hr>
            <button type="submit" class="btn btn-primary btn-lg">üíæ Save Prompt Overrides</button>
        </form>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const userFriendlyEditor = document.getElementById('user-friendly-editor');
                const advancedEditor = document.getElementById('advanced-editor');
                const editorSwitch = document.getElementById('prompt-editor-mode-switch');
                const promptTextarea = document.getElementById('prompt_overrides_textarea');

                function toggleEditorView() {
                    if (editorSwitch.checked) {
                        userFriendlyEditor.classList.remove('d-none');
                        advancedEditor.classList.add('d-none');
                    } else {
                        userFriendlyEditor.classList.add('d-none');
                        advancedEditor.classList.remove('d-none');
                    }
                }

                editorSwitch.addEventListener('change', toggleEditorView);
                toggleEditorView(); // Set initial state

                const container = document.getElementById('prompt-profiles-container');
                let profileCounter = container.children.length;

                const triggerTemplate = `
                    <div class="input-group mb-2">
                        <input type="text" class="form-control trigger-input" value="">
                        <button class="btn btn-outline-danger remove-item-btn" type="button">‚úñ</button>
                    </div>`;

                const overrideTemplate = `
                    <div class="input-group mb-2">
                        <span class="input-group-text" style="width: 50px;">Find</span>
                        <input type="text" class="form-control override-key-input" placeholder="Text to find" value="">
                        <span class="input-group-text" style="width: 80px;">Replace</span>
                        <input type="text" class="form-control override-value-input" placeholder="Replacement text" value="">
                        <button class="btn btn-outline-danger remove-item-btn" type="button">‚úñ</button>
                    </div>`;

                // Event delegation for all dynamic buttons inside the container
                container.addEventListener('click', function (e) {
                    if (e.target.classList.contains('add-trigger-btn')) {
                        e.target.previousElementSibling.insertAdjacentHTML('beforeend', triggerTemplate);
                    }
                    if (e.target.classList.contains('add-override-btn')) {
                        e.target.previousElementSibling.insertAdjacentHTML('beforeend', overrideTemplate);
                    }
                    if (e.target.classList.contains('remove-item-btn')) {
                        e.target.closest('.input-group').remove();
                    }
                    if (e.target.classList.contains('delete-profile-btn')) {
                        e.target.closest('.accordion-item').remove();
                    }
                });

                // Update accordion header as profile name changes
                container.addEventListener('input', function(e) {
                    if (e.target.classList.contains('profile-name-input')) {
                        const newName = e.target.value || 'New Profile';
                        const headerButton = e.target.closest('.accordion-item').querySelector('.accordion-button');
                        headerButton.textContent = newName;
                    }
                });

                // Add new profile
                document.getElementById('add-profile-btn').addEventListener('click', function () {
                    profileCounter++;
                    const newProfileName = `new_profile_${profileCounter}`;
                    const newProfileTemplate = `
                        <div class="accordion-item" data-profile-name="${newProfileName}">
                            <h2 class="accordion-header" id="heading-${profileCounter}">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${profileCounter}" aria-expanded="true" aria-controls="collapse-${profileCounter}">
                                    New Profile
                                </button>
                            </h2>
                            <div id="collapse-${profileCounter}" class="accordion-collapse collapse show" aria-labelledby="heading-${profileCounter}" data-bs-parent="#prompt-profiles-container">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <label class="form-label"><b>Profile Name</b></label>
                                        <input type="text" class="form-control profile-name-input" value="New Profile">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label"><b>Triggers</b></label>
                                        <div class="triggers-container"></div>
                                        <button class="btn btn-sm btn-outline-secondary add-trigger-btn" type="button">Add Trigger</button>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label"><b>Overrides</b></label>
                                        <div class="overrides-container"></div>
                                        <button class="btn btn-sm btn-outline-secondary add-override-btn" type="button">Add Override</button>
                                    </div>
                                    <button class="btn btn-danger delete-profile-btn" type="button">Delete Profile</button>
                                </div>
                            </div>
                        </div>`;
                    container.insertAdjacentHTML('beforeend', newProfileTemplate);
                });

                // Before submitting, collect all data and put it in the textarea if in user-friendly mode
                document.getElementById('prompt-form').addEventListener('submit', function () {
                    if (editorSwitch.checked) {
                        const profilesData = {};
                        container.querySelectorAll('.accordion-item').forEach(item => {
                            const nameInput = item.querySelector('.profile-name-input');
                            const profileName = nameInput ? nameInput.value.trim() : '';

                            if (profileName) {
                                const triggers = Array.from(item.querySelectorAll('.trigger-input'))
                                    .map(input => input.value.trim())
                                    .filter(Boolean);

                                const overrides = {};
                                item.querySelectorAll('.overrides-container .input-group').forEach(group => {
                                    const keyInput = group.querySelector('.override-key-input');
                                    const valueInput = group.querySelector('.override-value-input');
                                    if (keyInput && valueInput) {
                                        const key = keyInput.value;
                                        const value = valueInput.value;
                                        if (key) { // Key must not be empty
                                            overrides[key] = value;
                                        }
                                    }
                                });
                                profilesData[profileName] = { triggers, overrides };
                            }
                        });
                        promptTextarea.value = JSON.stringify(profilesData, null, 2);
                    }
                });
            });
        </script>
    </div>

</div> <!-- End .container -->

<!-- Bootstrap Footer -->
<footer class="footer mt-auto py-3 bg-light">
    <div class="container text-center">
        <span class="text-muted">‚úÖ Proxy server is running and ready to serve requests.</span>
    </div>
</footer>

<!-- Bootstrap JS Bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function showSectionBasedOnHash() {
            var hash = window.location.hash || '#home';
            var sectionId = hash.substring(1);

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(function(section) {
                section.style.display = 'none';
            });

            // Show the target section
            var targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
            } else {
                // Fallback to home if hash is invalid
                document.getElementById('home').style.display = 'block';
                hash = '#home';
            }

            // Update active link in navbar
            document.querySelectorAll('.navbar-nav .nav-link').forEach(function(link) {
                if (link.getAttribute('href') === hash) {
                    link.classList.add('active');
                    link.setAttribute('aria-current', 'page');
                } else {
                    link.classList.remove('active');
                    link.removeAttribute('aria-current');
                }
            });
        }

        // Run on page load
        showSectionBasedOnHash();

        // Run on hash change
        window.addEventListener('hashchange', showSectionBasedOnHash);

        // Close navbar toggler on link click for small screens
        document.querySelectorAll('.navbar-nav .nav-link').forEach(function(link) {
            link.addEventListener('click', function() {
                var navbarCollapse = document.getElementById('navbarNav');
                // Check if the navbar is actually collapsed (i.e., toggler is visible)
                var bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
                if (bsCollapse && navbarCollapse.classList.contains('show')) {
                    bsCollapse.hide();
                }
            });
        });
    });
</script>
</body>
</html>
