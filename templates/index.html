
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini to OpenAI Proxy</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        /* Small adjustment for the fixed Bootstrap navbar */
        body { padding-top: 5rem; }
        /* Custom styles for code blocks to fit Bootstrap's aesthetic */
        code { background-color: #e9ecef; padding: 2px 6px; border-radius: 4px; font-family: "SF Mono", "Fira Code", "Source Code Pro", monospace; }
        pre { background-color: #e9ecef; padding: 1em; border-radius: 4px; overflow-x: auto; }
        /* Ensure content sections are hidden by default, as before */
        .content-section { display: none; }
    </style>
</head>
<body>
<!-- Bootstrap Navbar -->
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <div class="container">
        <a class="navbar-brand" href="#">üöÄ Gemini to OpenAI Proxy</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="#home">üè† Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#configuration">‚öôÔ∏è Configuration</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#prompts">‚úçÔ∏è Prompts</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#mcp">üõ†Ô∏è MCP</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Main Content Container -->
<div class="container">
    <h1 class="my-4">üöÄ Gemini to OpenAI Proxy</h1>

    <!-- Home Section -->
    <div id="home" class="content-section">
        <p class="lead">This is a lightweight proxy server that translates requests from an OpenAI-compatible client (like JetBrains AI Assistant) to Google's Gemini API.</p>

        <h2 class="mt-4">‚ú® What It Does</h2>
        <ul>
            <li>Accepts requests on OpenAI-like endpoints: <code>/v1/chat/completions</code> and <code>/v1/models</code>.</li>
            <li>Transforms the request format from OpenAI's structure to Gemini's structure.</li>
            <li>Handles streaming responses for chat completions.</li>
            <li>Manages basic conversation history truncation to fit within the model's token limits.</li>
            <li>Caches model lists to reduce upstream API calls.</li>
            <li>Supports multimodal requests (text and images).</li>
            <li>Supports MCP tools for function calling.</li>
        </ul>

        <h2 class="mt-4">üöÄ How to Use</h2>

        <h3>1. Setup and Run</h3>
        <p>Before running the server, you need to set one environment variable (or use the form above for the API Key):</p>
        <pre><code class="language-bash">
 export API_KEY="YOUR_GEMINI_API_KEY"
 export UPSTREAM_URL="https://generativelanguage.googleapis.com"
        </code></pre>
        <p>Then, run the server:</p>
        <pre><code class="language-bash">
 python3.12 -m venv
 source venv/bin/activate
 pip install -r requirements.txt
 python3.12 gemini-proxy.py
        </code></pre>
        <p>or Docker Version</p>
        <pre><code class="language-bash">docker-composer up -d</code></pre>
        <p>The server will start on <code>http://0.0.0.0:8080</code> by default.</p>


        <h3 class="mt-4">2. Configure JetBrains AI Assistant</h3>
        <p>To use this proxy with JetBrains IDEs:</p>
        <ol>
            <li>Open AI Assistant settings (<code>Settings</code> > <code>Tools</code> > <code>AI Assistant</code> > <code>Models</code>).</li>
            <li>Select the "OpenAI API" service.</li>
            <li>Set the <b>Server URL</b> to: <code>http://&lt;your-server-ip-or-localhost&gt;:8080/v1/</code></li>
            <li>The model list will be fetched automatically. You can leave it as default or choose a specific one.</li>
        </ol>
        <p class="alert alert-info"><b>Note:</b> The path must end with <code>/v1/</code> because the IDE will append <code>/chat/completions</code> or <code>/models</code> to it.</p>

        <h2 class="mt-4">üì° Available Endpoints</h2>
        <ul>
            <li><code>GET /</code>: This documentation and setup page.</li>
            <li><code>GET /v1/models</code>: Lists available Gemini models in OpenAI format.</li>
            <li><code>POST /v1/chat/completions</code>: The main endpoint for chat completions. Supports streaming.</li>
        </ul>
    </div>

    <!-- Configuration Section -->
    <div id="configuration" class="content-section">
        <h2 class="mt-4">üîë API Key Setup</h2>
        <p>You can set your Gemini API Key using the form below. The key is stored in memory and will be reset when the server restarts. You can also set it permanently using the <code>API_KEY</code> environment variable.</p>
        <form action="/set_api_key" method="POST">
            <div class="mb-3">
                <label for="api_key" class="form-label"><b>üîë Gemini API Key:</b></label>
                <input type="text" class="form-control" id="api_key" name="api_key" placeholder="Enter your Gemini API key" value="{{ API_KEY or '' }}">
            </div>
            <button type="submit" class="btn btn-primary">üíæ Save Key</button>
        </form>
        <p class="mt-3"><b>Current Status:</b> The API Key is currently <strong class="text-{{ 'success' if API_KEY else 'danger' }}">{{ api_key_status }}</strong>.</p>

        <hr class="my-4">
        <h3 class="mt-4">üêû Debugging</h3>
        <form action="/set_logging" method="POST">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="verbose_logging" name="verbose_logging"
                       {% if verbose_logging_status %}checked{% endif %} onchange="this.form.submit()">
                <label class="form-check-label" for="verbose_logging">Enable Verbose Console Logging</label>
            </div>
            <div class="form-text">Toggles detailed logging of requests, responses, and other events in the server console.</div>
        </form>
    </div>

    <!-- MCP Tools Section -->
    <div id="mcp" class="content-section">
        <h2 class="mt-4">üõ†Ô∏è MCP Tools Configuration</h2>
        <p>Configure MCP tools by providing a JSON configuration. This will be saved to <code>mcp_config.json</code>.</p>
        <form action="/set_mcp_config" method="POST">
            <div class="mb-3">
                <label for="mcp_config" class="form-label"><b>üõ†Ô∏è MCP JSON Config:</b></label>
                <textarea class="form-control" id="mcp_config" name="mcp_config" rows="15">{{ current_mcp_config_str or default_mcp_config_json }}</textarea>
            </div>
            <button type="submit" class="btn btn-primary">üíæ Save MCP Config</button>
        </form>
    </div>

    <!-- Prompt Engineering Section -->
    <div id="prompts" class="content-section">
        <h2 class="mt-4">‚úçÔ∏è Prompt Engineering</h2>
        <p>Define different profiles for prompt overrides. Each profile has a name, a list of 'triggers' to activate it, and an 'overrides' dictionary for replacements. The proxy will check incoming messages for trigger phrases and apply the overrides from the first matching profile. This is useful for handling different contexts, like regular chat vs. commit message generation.</p>
        <form action="/set_prompt_config" method="POST">
            <div class="mb-3">
                <label for="prompt_overrides" class="form-label"><b>‚úçÔ∏è Prompt Overrides (JSON):</b></label>
                <textarea class="form-control" id="prompt_overrides" name="prompt_overrides" rows="10">{{ current_prompt_overrides_str or default_prompt_overrides_json }}</textarea>
            </div>
            <button type="submit" class="btn btn-primary">üíæ Save Prompt Overrides</button>
        </form>
    </div>

</div> <!-- End .container -->

<!-- Bootstrap Footer -->
<footer class="footer mt-auto py-3 bg-light">
    <div class="container text-center">
        <span class="text-muted">‚úÖ Proxy server is running and ready to serve requests.</span>
    </div>
</footer>

<!-- Bootstrap JS Bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function showSectionBasedOnHash() {
            var hash = window.location.hash || '#home';
            var sectionId = hash.substring(1);

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(function(section) {
                section.style.display = 'none';
            });

            // Show the target section
            var targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
            } else {
                // Fallback to home if hash is invalid
                document.getElementById('home').style.display = 'block';
                hash = '#home';
            }

            // Update active link in navbar
            document.querySelectorAll('.navbar-nav .nav-link').forEach(function(link) {
                if (link.getAttribute('href') === hash) {
                    link.classList.add('active');
                    link.setAttribute('aria-current', 'page');
                } else {
                    link.classList.remove('active');
                    link.removeAttribute('aria-current');
                }
            });
        }

        // Run on page load
        showSectionBasedOnHash();

        // Run on hash change
        window.addEventListener('hashchange', showSectionBasedOnHash);

        // Close navbar toggler on link click for small screens
        document.querySelectorAll('.navbar-nav .nav-link').forEach(function(link) {
            link.addEventListener('click', function() {
                var navbarCollapse = document.getElementById('navbarNav');
                // Check if the navbar is actually collapsed (i.e., toggler is visible)
                var bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
                if (bsCollapse && navbarCollapse.classList.contains('show')) {
                    bsCollapse.hide();
                }
            });
        });
    });
</script>
</body>
</html>